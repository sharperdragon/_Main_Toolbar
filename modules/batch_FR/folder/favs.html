<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Favorites Manager</title>
    <style>
        /* === Layout shell === */
        .window-dialog {
            display: flex;
            align-items: stretch;
            justify-content: center;
            gap: 0.75rem;             
            padding: 0.75rem;
            min-width: 560px;
            min-height: 320px;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .items-panel {
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            border: 1px solid #d0d4dd;
            border-radius: 6px;
            padding: 0.5rem;
            box-sizing: border-box;
            background: #fafbff;
        }

        .items-panel-header {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            color: #444b5a;
        }

        .favorites-list {
            flex: 1 1 auto;
            border: 1px solid #d0d4dd;
            border-radius: 4px;
            background: #ffffff;
            padding: 0.25rem;
            margin: 0;
            list-style: none;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .favorites-item {
            padding: 0.25rem 0.4rem;
            border-radius: 3px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .favorites-item:hover {
            background: #eef2ff;
        }

        .favorites-item.is-selected {
            background: #dbe4ff;
            border: 1px solid #b5c4ff;
        }

        /* === Middle controls column === */
        .favorites-controls {
            flex: 0 0 60px;           
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: center;
            gap: 0.5rem;
        }

        .move-item-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #c9cfdd;
            background: #f3f5ff;
            font-size: 1.05rem;
            cursor: pointer;
            transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.1s ease;
        }

        .move-item-button:disabled {
            opacity: 0.8;
            cursor: default;
            box-shadow: none;
            transform: none;
        }

        .move-item-button:hover:not(:disabled) {
            background: #e2e7ff;
            box-shadow: 0 0 0 1px #c2ccff;
        }

        .move-item-button:active:not(:disabled) {
            transform: translateY(1px);
        }

        .move-item-button.primary {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="window-dialog">
        <!-- Left panel: all items -->
        <section class="items-panel" aria-label="Available items">
            <div class="items-panel-header">Available items</div>
            <ul class="favorites-list" id="available-list">
                <!-- Items are provided dynamically from Python -->
            </ul>
        </section>

        <!-- Middle controls -->
        <div class="favorites-controls">
            <button
                type="button"
                class="move-item-button primary"
                id="btn-add-to-favorites"
                title="Add selected item(s) to favorites (move from left to right)"
            > ≫ </button>

            <button
                type="button"
                class="move-item-button"
                id="btn-remove-from-favorites"
                title="Remove selected item(s) from favorites (move from right to left)"
            > ≪ </button>
        </div>

        <!-- Right panel: favorites group -->
        <section class="items-panel" aria-label="Favorites group">
            <div class="items-panel-header">Favorites</div>
            <ul class="favorites-list" id="favorites-list">
                <!-- Selected favorite items will appear here -->
            </ul>
        </section>
    </div>

<script>
(() => {
    // 14-00_12-06  – simple, single-selection favorites mover

    // ! Bridge helper to talk to Anki / Python
    function sendToPython(message) {
        const payload = "batchFrFavs:" + JSON.stringify(message);

        try {
            // Anki normally injects a global pycmd(...) function
            if (typeof pycmd === "function") {
                pycmd(payload);
            } else if (window.pycmd && typeof window.pycmd === "function") {
                window.pycmd(payload);
            } else if (window.external && typeof window.external.pycmd === "function") {
                window.external.pycmd(payload);
            } else {
                console.warn("Batch_FR favorites: pycmd bridge is not available.", message);
            }
        } catch (e) {
            console.error("Batch_FR favorites: error sending to Python:", e, message);
        }
    }

    // ! Core elements
    const availableList = document.getElementById("available-list");
    const favoritesList = document.getElementById("favorites-list");
    const btnAdd       = document.getElementById("btn-add-to-favorites");
    const btnRemove    = document.getElementById("btn-remove-from-favorites");

    let selectedItem = null;  // currently selected <li>, from either list

    // * Called from Python with the full list of files + favorites
    //   payload: { files: [{ path, name, label, group, favorite }, ...] }
    window.batchFrFavsInit = function (payload) {
        availableList.innerHTML = "";
        favoritesList.innerHTML = "";
        selectedItem = null;
        updateButtons();

        console.log(
            "Batch_FR favorites: initializing with",
            (payload && payload.files && payload.files.length) || 0,
            "files"
        );

        const seen = new Set();

        (payload.files || []).forEach(file => {
            if (!file.path || seen.has(file.path)) {
                return;
            }
            seen.add(file.path);

            const li = document.createElement("li");
            li.className = "favorites-item";
            li.dataset.path = file.path;
            li.dataset.group = file.group || "";

            const labelText = "[" + (file.group || "unknown") + "] " +
                (file.label || file.name || file.path);
            li.textContent = labelText;

            attachItemClick(li);

            if (file.favorite) {
                favoritesList.appendChild(li);
            } else {
                availableList.appendChild(li);
            }
        });

        // Recalculate layout based on real content
        applyPanelMaxWidth();
    };

    // * Selection helpers
    function clearSelection() {
        if (selectedItem) {
            selectedItem.classList.remove("is-selected");
        }
        selectedItem = null;
        updateButtons();
    }

    function selectItem(item) {
        // Clicking the same item again will unselect it
        if (selectedItem === item) {
            clearSelection();
            return;
        }

        if (selectedItem) {
            selectedItem.classList.remove("is-selected");
        }

        selectedItem = item;
        selectedItem.classList.add("is-selected");
        updateButtons();
    }

    function updateButtons() {
        // Enable "≫" only when a left-side item is selected
        btnAdd.disabled = !(
            selectedItem &&
            selectedItem.parentElement === availableList
        );

        // Enable "≪" only when a right-side item is selected
        btnRemove.disabled = !(
            selectedItem &&
            selectedItem.parentElement === favoritesList
        );
    }

    // * Measure the longest rendered item width
    function measureLongestItemWidth() {
        const items = document.querySelectorAll(".favorites-item");
        if (!items.length) {
            return 0;
        }

        // Hidden probe element to measure text with same styling
        const probe = document.createElement("span");
        probe.className = "favorites-item";
        probe.style.position = "absolute";
        probe.style.visibility = "hidden";
        probe.style.whiteSpace = "nowrap";
        document.body.appendChild(probe);

        let maxWidth = 0;

        items.forEach(item => {
            probe.textContent = item.textContent;
            const width = probe.offsetWidth;
            if (width > maxWidth) {
                maxWidth = width;
            }
        });

        document.body.removeChild(probe);
        return maxWidth;
    }

    // * Apply max-width to panels = 2x longest item + padding
    function applyPanelMaxWidth() {
        const longest = measureLongestItemWidth();
        if (!longest) {
            return;
        }

        // ! Adjust this padding allowance if the panels feel too tight/loose
        const paddingAllowance = 64; // px to account for padding + borders
        const desiredMax = longest * 3 + paddingAllowance;

        const panels = document.querySelectorAll(".items-panel");
        panels.forEach(panel => {
            panel.style.maxWidth = desiredMax + "px";
        });
    }

    // ? Attach click handler to each item so it can be selected
    function attachItemClick(item) {
        item.addEventListener("click", () => selectItem(item));
    }

    // * Move selected item from left -> right (add to favorites)
    btnAdd.addEventListener("click", () => {
        if (!selectedItem) return;
        if (selectedItem.parentElement !== availableList) return;

        favoritesList.appendChild(selectedItem);

        // Keep the item selected after moving so keyboard navigation continues
        selectedItem.scrollIntoView({ block: "nearest" });
        updateButtons();
    });

    // * Move selected item from right -> left (remove from favorites)
    btnRemove.addEventListener("click", () => {
        if (!selectedItem) return;
        if (selectedItem.parentElement !== favoritesList) return;

        availableList.appendChild(selectedItem);

        // Keep the item selected after moving so keyboard navigation continues
        selectedItem.scrollIntoView({ block: "nearest" });
        updateButtons();
    });

    // * Keyboard navigation: Up/Down to change selection, Left/Right to move between panels
    document.addEventListener("keydown", (event) => {
        const { key } = event;
        const arrowKeys = ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"];
        if (!arrowKeys.includes(key)) {
            return;
        }

        // If nothing is selected yet, start on the first available item
        if (!selectedItem) {
            const first =
                availableList.querySelector(".favorites-item") ||
                favoritesList.querySelector(".favorites-item");
            if (!first) {
                return;
            }
            selectItem(first);
            event.preventDefault();
            return;
        }

        // Helper to move selection within the current list
        function moveSelection(delta) {
            const parentList = selectedItem.parentElement;
            if (!parentList || !parentList.classList.contains("favorites-list")) {
                return;
            }

            const items = Array.from(parentList.querySelectorAll(".favorites-item"));
            const idx = items.indexOf(selectedItem);
            if (idx === -1) {
                return;
            }

            let nextIdx = idx + delta;
            if (nextIdx < 0) nextIdx = 0;
            if (nextIdx >= items.length) nextIdx = items.length - 1;

            if (nextIdx !== idx) {
                selectItem(items[nextIdx]);
                items[nextIdx].scrollIntoView({ block: "nearest" });
            }
        }

        if (key === "ArrowUp") {
            moveSelection(-1);
            event.preventDefault();
        } else if (key === "ArrowDown") {
            moveSelection(1);
            event.preventDefault();
        } else if (key === "ArrowRight") {
            // Move selected item from left panel to right panel
            if (selectedItem.parentElement === availableList) {
                event.preventDefault();
                btnAdd.click();
            }
        } else if (key === "ArrowLeft") {
            // Move selected item from right panel to left panel
            if (selectedItem.parentElement === favoritesList) {
                event.preventDefault();
                btnRemove.click();
            }
        }
    });

    // * Called by Python when the user clicks OK in the Qt dialog
    //   Returns the current favorites (right-hand list) to Python
    window.batchFrFavsCollect = function () {
        const favorites = [];
        favoritesList.querySelectorAll(".favorites-item").forEach(li => {
            if (li.dataset.path) {
                favorites.push(li.dataset.path);
            }
        });

        sendToPython({
            command: "save",
            favorites: favorites,
        });
    };

    // When this page loads inside Anki, ask Python for initial data
    sendToPython({ command: "ready" });

    // * Set initial max-width for panels based on content
    applyPanelMaxWidth();
})();
</script>
</body>
</html>